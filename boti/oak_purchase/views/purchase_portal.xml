<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    <template
        id="oak_purchase_order_portal_content_inherit"
        name="Oak Purchase Order Portal"
        priority="110"
        inherit_id="purchase.purchase_order_portal_content"
    >
        <xpath expr="//table/thead/tr" position="replace">
            <th class="text-start">Products</th>
            <th class="text-end">Quantity</th>
            <th class="text-end">Requested Date</th>
            <th t-if="update_dates" class="text-end">Scheduled Date</th>
            <th t-if="update_dates" class="text-end"><strong>Update Here</strong></th>
            <th
                t-if="not update_dates and order.state in ['purchase', 'done']"
                t-attf-class="text-end {{ 'd-none d-sm-table-cell' if report_type == 'html' else '' }}"
            >Unit Price</th>
            <th
                t-if="not update_dates and order.state in ['purchase', 'done']"
                t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}"
            >
                <span>Taxes</span>
            </th>
            <th class="text-end" t-if="order.state in ['purchase', 'done']">
                <span
                    groups="account.group_show_line_subtotals_tax_excluded"
                >Amount</span>
                <span
                    groups="account.group_show_line_subtotals_tax_included"
                >Total Price</span>
            </th>
        </xpath>
        <xpath expr="//table/tbody" position="replace">
             <t t-set="current_subtotal" t-value="0" />

                <t t-foreach="order.order_line" t-as="line">

                    <t
                    t-set="current_subtotal"
                    t-value="current_subtotal + line.price_subtotal"
                    groups="account.group_show_line_subtotals_tax_excluded"
                />
                    <t
                    t-set="current_subtotal"
                    t-value="current_subtotal + line.price_total"
                    groups="account.group_show_line_subtotals_tax_included"
                />

                <tr
                    t-att-class="'bg-200 fw-bold o_line_section' if line.display_type == 'line_section' else 'fst-italic text-break' if line.display_type == 'line_note' else ''"
                >
                    <t t-if="not line.display_type">
                        <td id="product_name">
                            <img
                                t-att-src="image_data_uri(resize_to_48(line.product_id.image_1024))"
                                alt="Product"
                                class="d-none d-lg-inline"
                            />
                            <span t-field="line.name" />
                        </td>
                        <td class="text-end">
                            <div id="quote_qty">
                                <span t-field="line.product_qty" />
                                <span
                                    t-field="line.product_uom"
                                    groups="uom.group_uom"
                                />
                            </div>
                        </td>
                        <td class="text-end">
                            <t t-if="line.requested_date">
                                <span t-esc="line.requested_date.date()" />
                            </t>
                            <t t-else="">
                                <span>None</span>
                            </t>
                        </td>
                        <td t-if="update_dates" class="text-end"><span
                                t-esc="line.date_planned.date()"
                            /></td>
                        <td t-if="update_dates" class="text-end">
                            <form
                                t-attf-action="/my/purchase/#{order.id}/update?access_token=#{order.access_token}"
                                method="post"
                            >
                            <input
                                    type="hidden"
                                    name="csrf_token"
                                    t-att-value="request.csrf_token()"
                                />
                            <div class="container">
                                <div class="mb-3">
                                <div class="input-group date">
                                    <input
                                                type="text"
                                                class="form-control datetimepicker-input o-purchase-datetimepicker"
                                                t-attf-id="datetimepicker_#{line.id}"
                                                t-att-name="line.id"
                                                data-toggle="datetimepicker"
                                                data-date-format="YYYY-MM-DD"
                                                t-attf-data-target="#datetimepicker_#{line.id}"
                                            />
                                </div>
                                </div>
                            </div>
                            </form>
                        </td>
                        <td
                            t-if="not update_dates and order.state in ['purchase', 'done']"
                            t-attf-class="text-end {{ 'd-none d-sm-table-cell' if report_type == 'html' else '' }}"
                        >
                            <div t-field="line.price_unit" class="text-end" />
                        </td>
                        <td
                            t-if="not update_dates and order.state in ['purchase', 'done']"
                            t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}"
                        >
                            <span
                                t-esc="', '.join(map(lambda x: (x.description or x.name), line.taxes_id))"
                            />
                        </td>
                        <td
                            class="text-end"
                            t-if="not update_dates and order.state in ['purchase', 'done']"
                        >
                            <span
                                class="oe_order_line_price_subtotal"
                                t-field="line.price_subtotal"
                                groups="account.group_show_line_subtotals_tax_excluded"
                            />
                            <span
                                class="oe_order_line_price_total"
                                t-field="line.price_total"
                                groups="account.group_show_line_subtotals_tax_included"
                            />
                        </td>
                    </t>
                    <t t-if="line.display_type == 'line_section'">
                        <td colspan="99">
                            <span t-field="line.name" />
                        </td>
                        <t t-set="current_section" t-value="line" />
                        <t t-set="current_subtotal" t-value="0" />
                    </t>
                    <t t-if="line.display_type == 'line_note'">
                        <td colspan="99">
                            <span t-field="line.name" />
                        </td>
                    </t>
                </tr>

                <t
                    t-if="current_section and (line_last or order.order_line[line_index+1].display_type == 'line_section') and order.state in ['purchase', 'done']"
                >
                    <tr class="is-subtotal text-end">
                        <td colspan="99">
                            <strong class="mr16">Subtotal</strong>
                            <span
                                t-esc="current_subtotal"
                                t-options='{"widget": "monetary", "display_currency": order.currency_id}'
                            />
                        </td>
                    </tr>
                </t>
            </t>
        </xpath>
    </template>
</odoo>
